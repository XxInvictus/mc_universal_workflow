name: 0. CI Validation

on:
  pull_request:
  push:
    branches:
      - main
    paths-ignore:
      - 'README*'
      - 'LICENSE*'
      - 'TEMPLATE_LICENSE.txt'
      - 'CREDITS.txt'
      - 'docs/**'
      - '.gitignore'
      - '.github/instructions/**'
      - changelog.txt

  workflow_dispatch:

permissions:
  contents: read

jobs:
  scripts:
    name: Validate scripts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install test tools
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y zip unzip binutils jq

      - name: Install yq (pinned)
        shell: bash
        run: |
          set -euo pipefail
          YQ_VERSION="v4.44.3"
          ARCH="amd64"
          OS="linux"
          sudo wget -q "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_${OS}_${ARCH}" -O /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq
          yq --version

      - name: Bash syntax check
        shell: bash
        run: |
          set -euo pipefail
          bash -n scripts/quick-detect.sh
          bash -n scripts/extract-properties.sh
          bash -n scripts/compute-artifact-path.sh
          bash -n scripts/validate-artifact-path.sh
          bash -n scripts/validate-artifacts.sh
          bash -n scripts/validate-mappings.sh
          bash -n scripts/validate-gradle-properties.sh
          bash -n scripts/validate-dependencies-yml.sh
          bash -n scripts/download-runtime-deps.sh
          bash -n scripts/prepare-test-env.sh
          bash -n scripts/health-check.sh
          bash -n scripts/migration/scan-legacy-gradle-properties.sh
          bash -n scripts/migration/migrate-legacy-gradle-properties.sh
          bash -n scripts/tests/quick-detect-test.sh
          bash -n scripts/tests/extract-properties-test.sh
          bash -n scripts/tests/artifact-path-test.sh
          bash -n scripts/tests/validate-artifacts-test.sh
          bash -n scripts/tests/validate-mappings-test.sh
          bash -n scripts/tests/validate-gradle-properties-test.sh
          bash -n scripts/tests/dependencies-yml-test.sh
          bash -n scripts/tests/download-runtime-deps-test.sh
          bash -n scripts/tests/prepare-test-env-test.sh
          bash -n scripts/tests/health-check-test.sh
          bash -n scripts/tests/migration-helpers-test.sh
          bash -n scripts/tests/mojang-version-manifest-test.sh
          bash -n scripts/tests/mc-runtime-test-assets-test.sh

      - name: Run script tests
        shell: bash
        run: |
          set -euo pipefail
          bash scripts/tests/quick-detect-test.sh
          bash scripts/tests/extract-properties-test.sh
          bash scripts/tests/artifact-path-test.sh
          bash scripts/tests/validate-artifacts-test.sh
          bash scripts/tests/validate-mappings-test.sh
          bash scripts/tests/validate-gradle-properties-test.sh
          bash scripts/tests/dependencies-yml-test.sh
          bash scripts/tests/download-runtime-deps-test.sh
          bash scripts/tests/prepare-test-env-test.sh
          bash scripts/tests/health-check-test.sh
          bash scripts/tests/migration-helpers-test.sh
          bash scripts/tests/mojang-version-manifest-test.sh
          bash scripts/tests/mc-runtime-test-assets-test.sh

  artifact-handoff:
    name: Validate artifact upload/download paths
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create single-loader fixture
        shell: bash
        run: |
          set -euo pipefail
          rm -rf single-fixture
          mkdir -p single-fixture/build/libs

          # Simulate a built jar at the enforced single-loader location.
          printf 'dummy-jar\n' > single-fixture/build/libs/examplemod-forge-1.21.1-0.1.0.jar

          # Marker used to force upload-artifact's common ancestor to be project root.
          printf 'artifact-root\n' > single-fixture/.mc_universal_workflow_artifact_root

      - name: Upload single-loader artifact set
        uses: actions/upload-artifact@v4
        with:
          name: ci-artifact-handoff-single
          path: |
            single-fixture/.mc_universal_workflow_artifact_root
            single-fixture/build/libs/examplemod-forge-1.21.1-0.1.0.jar
          if-no-files-found: error

      - name: Create multi-loader fixture
        shell: bash
        run: |
          set -euo pipefail
          rm -rf multi-fixture
          mkdir -p multi-fixture/forge/build/libs multi-fixture/fabric/build/libs

          printf 'dummy-jar\n' > multi-fixture/forge/build/libs/examplemod-forge-1.21.1-0.1.0.jar
          printf 'dummy-jar\n' > multi-fixture/fabric/build/libs/examplemod-fabric-1.21.1-0.1.0.jar

          # Same marker strategy for multi-loader.
          printf 'artifact-root\n' > multi-fixture/.mc_universal_workflow_artifact_root

      - name: Upload multi-loader artifact set
        uses: actions/upload-artifact@v4
        with:
          name: ci-artifact-handoff-multi
          path: |
            multi-fixture/.mc_universal_workflow_artifact_root
            multi-fixture/forge/build/libs/examplemod-forge-1.21.1-0.1.0.jar
            multi-fixture/fabric/build/libs/examplemod-fabric-1.21.1-0.1.0.jar
          if-no-files-found: error

      - name: Wipe fixtures before download
        shell: bash
        run: |
          set -euo pipefail
          rm -rf single-fixture multi-fixture
          rm -rf ./build ./forge ./fabric || true
          rm -f ./*.jar ./.mc_universal_workflow_artifact_root || true

      - name: Download single-loader artifact set
        uses: actions/download-artifact@v4
        with:
          name: ci-artifact-handoff-single
          path: .

      - name: Assert single-loader restore path
        shell: bash
        run: |
          set -euo pipefail
          # Note: upload-artifact stores files relative to the common ancestor (single-fixture/).
          # When downloading into '.', the single-fixture/ prefix is not preserved.
          # Also: the marker is a hidden dotfile; upload-artifact does not include hidden files by default.
          [[ -f "build/libs/examplemod-forge-1.21.1-0.1.0.jar" ]] || { echo "ERROR: expected jar not restored under build/libs" >&2; exit 1; }

          # Regression check: the jar should not be flattened into workspace root.
          [[ ! -f "./examplemod-forge-1.21.1-0.1.0.jar" ]] || { echo "ERROR: jar was flattened into workspace root" >&2; exit 1; }

      - name: Download multi-loader artifact set
        uses: actions/download-artifact@v4
        with:
          name: ci-artifact-handoff-multi
          path: .

      - name: Assert multi-loader restore paths
        shell: bash
        run: |
          set -euo pipefail
          # Note: upload-artifact stores files relative to the common ancestor (multi-fixture/).
          # When downloading into '.', the multi-fixture/ prefix is not preserved.
          [[ -f "forge/build/libs/examplemod-forge-1.21.1-0.1.0.jar" ]] || { echo "ERROR: expected forge jar not restored under forge/build/libs" >&2; exit 1; }
          [[ -f "fabric/build/libs/examplemod-fabric-1.21.1-0.1.0.jar" ]] || { echo "ERROR: expected fabric jar not restored under fabric/build/libs" >&2; exit 1; }

      - name: "Create single-loader fixture (known-broken: no marker)"
        shell: bash
        run: |
          set -euo pipefail
          rm -rf broken-single-fixture
          mkdir -p broken-single-fixture/build/libs

          # Simulate a built jar at the enforced single-loader location.
          printf 'dummy-jar\n' > broken-single-fixture/build/libs/examplemod-forge-1.21.1-0.1.0.jar

      - name: "Upload single-loader artifact set (known-broken: no marker)"
        uses: actions/upload-artifact@v4
        with:
          name: ci-artifact-handoff-single-broken
          path: |
            broken-single-fixture/build/libs/examplemod-forge-1.21.1-0.1.0.jar
          if-no-files-found: error

      - name: "Download single-loader artifact set (known-broken: no marker)"
        uses: actions/download-artifact@v4
        with:
          name: ci-artifact-handoff-single-broken
          path: broken-download

      - name: Assert known-broken restore behavior (single-loader)
        shell: bash
        run: |
          set -euo pipefail

          # Without the marker file, upload-artifact picks build/libs as the common ancestor,
          # so the jar is stored at the artifact root and restores flattened.
          [[ -f "broken-download/examplemod-forge-1.21.1-0.1.0.jar" ]] || { echo "ERROR: expected flattened jar at broken-download/ (known-broken behavior)" >&2; exit 1; }
          [[ ! -f "broken-download/broken-single-fixture/build/libs/examplemod-forge-1.21.1-0.1.0.jar" ]] || { echo "ERROR: jar unexpectedly preserved directory structure in known-broken case" >&2; exit 1; }

  composite-action:
    name: Validate composite action
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install test tools
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y zip unzip binutils jq

      - name: Install yq (pinned)
        shell: bash
        run: |
          set -euo pipefail
          YQ_VERSION="v4.44.3"
          ARCH="amd64"
          OS="linux"
          sudo wget -q "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_${OS}_${ARCH}" -O /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq
          yq --version

      - name: Create fixture project
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p fixture
          cat > fixture/gradle.properties <<'EOF'
          minecraft_version=1.21.1
          mod_id=examplemod
          mod_version=0.1.0
          loader_multi=false
          loader_type=forge
          java_version=21
          EOF

          mkdir -p fixture/build/libs fixture/META-INF fixture/markers
          cat > fixture/META-INF/MANIFEST.MF <<'EOF'
          Manifest-Version: 1.0
          EOF

          cat > fixture/META-INF/mods.toml <<'EOF'
          modLoader="javafml"
          loaderVersion="[1,)"
          license="MIT"
          [[mods]]
          modId="examplemod"
          version="0.1.0"
          EOF

          # Add SRG marker strings so validate-mappings detects Forge as SRG.
          for i in $(seq 1 50); do
            echo "func_1234_a" >> fixture/markers/srg.txt
            echo "field_5678_b" >> fixture/markers/srg.txt
          done

          (cd fixture && zip -q "build/libs/examplemod-forge-1.21.1-0.1.0.jar" META-INF/MANIFEST.MF META-INF/mods.toml markers/srg.txt)

      - name: Run detect-project action
        id: detect
        uses: XxInvictus/mc_universal_workflow/.github/actions/detect-project@main
        with:
          project-root: fixture

      - name: Assert outputs
        shell: bash
        run: |
          set -euo pipefail
          [[ "${{ steps.detect.outputs.minecraft_version }}" == "1.21.1" ]]
          [[ "${{ steps.detect.outputs.active_loaders }}" == "forge" ]]

      - name: Run resolve-artifact action (single-loader)
        id: resolve_single
        uses: XxInvictus/mc_universal_workflow/.github/actions/resolve-artifact@main
        with:
          project-root: fixture

      - name: Assert resolve-artifact outputs (single-loader)
        shell: bash
        run: |
          set -euo pipefail
          [[ "${{ steps.resolve_single.outputs.artifact_path }}" == "build/libs/examplemod-forge-1.21.1-0.1.0.jar" ]]

      - name: Run validate-artifacts action (single-loader)
        id: val_art
        uses: XxInvictus/mc_universal_workflow/.github/actions/validate-artifacts@main
        with:
          project-root: fixture

      - name: Run validate-mappings action (single-loader)
        id: val_map
        uses: XxInvictus/mc_universal_workflow/.github/actions/validate-mappings@main
        with:
          project-root: fixture

      - name: Assert validate-* outputs (single-loader)
        shell: bash
        run: |
          set -euo pipefail
          [[ "${{ steps.val_art.outputs.validation_status }}" == "pass" ]]
          [[ "${{ steps.val_map.outputs.validation_status }}" == "pass" ]]
          [[ "${{ steps.val_map.outputs.mapping_type }}" == "srg" || "${{ steps.val_map.outputs.mapping_type }}" == "mojmap" ]]

      - name: Create multi-loader fixture project
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p fixture-multi/forge fixture-multi/fabric
          : > fixture-multi/forge/build.gradle
          : > fixture-multi/fabric/build.gradle
          cat > fixture-multi/gradle.properties <<'EOF'
          minecraft_version=1.21.1
          mod_id=examplemod
          mod_version=0.1.0
          loader_multi=true
          active_loaders=forge,fabric
          java_version=21
          EOF

          # Create minimal, valid forge and fabric jars at the enforced locations.
          mkdir -p fixture-multi/forge/build/libs fixture-multi/forge/META-INF fixture-multi/forge/markers
          cat > fixture-multi/forge/META-INF/MANIFEST.MF <<'EOF'
          Manifest-Version: 1.0
          EOF
          cat > fixture-multi/forge/META-INF/mods.toml <<'EOF'
          modLoader="javafml"
          loaderVersion="[1,)"
          license="MIT"
          [[mods]]
          modId="examplemod"
          version="0.1.0"
          EOF
          for i in $(seq 1 50); do
            echo "func_1234_a" >> fixture-multi/forge/markers/srg.txt
            echo "field_5678_b" >> fixture-multi/forge/markers/srg.txt
          done
          (cd fixture-multi/forge && zip -q "build/libs/examplemod-forge-1.21.1-0.1.0.jar" META-INF/MANIFEST.MF META-INF/mods.toml markers/srg.txt)

          mkdir -p fixture-multi/fabric/build/libs fixture-multi/fabric/META-INF fixture-multi/fabric/markers
          cat > fixture-multi/fabric/META-INF/MANIFEST.MF <<'EOF'
          Manifest-Version: 1.0
          EOF
          cat > fixture-multi/fabric/fabric.mod.json <<'EOF'
          {"schemaVersion":1,"id":"examplemod","version":"0.1.0","name":"Example Mod"}
          EOF
          for i in $(seq 1 50); do
            echo "class_1234" >> fixture-multi/fabric/markers/inter.txt
            echo "method_5678" >> fixture-multi/fabric/markers/inter.txt
          done
          (cd fixture-multi/fabric && zip -q "build/libs/examplemod-fabric-1.21.1-0.1.0.jar" META-INF/MANIFEST.MF fabric.mod.json markers/inter.txt)

      - name: Run resolve-artifact action (multi-loader)
        id: resolve_multi
        uses: XxInvictus/mc_universal_workflow/.github/actions/resolve-artifact@main
        with:
          project-root: fixture-multi
          loader: forge

      - name: Assert resolve-artifact outputs (multi-loader)
        shell: bash
        run: |
          set -euo pipefail
          [[ "${{ steps.resolve_multi.outputs.artifact_path }}" == "forge/build/libs/examplemod-forge-1.21.1-0.1.0.jar" ]]

      - name: Validate multi-loader artifacts and mappings
        shell: bash
        run: |
          set -euo pipefail
          bash scripts/validate-artifacts.sh --project-root fixture-multi --loader forge
          bash scripts/validate-mappings.sh --project-root fixture-multi --loader forge
          bash scripts/validate-artifacts.sh --project-root fixture-multi --loader fabric
          bash scripts/validate-mappings.sh --project-root fixture-multi --loader fabric

      - name: Create dependencies.yml fixture
        shell: bash
        run: |
          set -euo pipefail
          cat > fixture/dependencies.yml <<'EOF'
          version: "1.0"
          settings:
            auto_resolve_latest: false
          dependencies:
            runtime: []
          EOF

      - name: Run validate-dependencies action
        id: deps
        uses: XxInvictus/mc_universal_workflow/.github/actions/validate-dependencies@main
        with:
          project-root: fixture

      - name: Assert validate-dependencies outputs
        shell: bash
        run: |
          set -euo pipefail
          [[ "${{ steps.deps.outputs.dependencies_present }}" == "true" ]]

      - name: Create fixture without dependencies.yml
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p fixture-no-deps
          cat > fixture-no-deps/gradle.properties <<'EOF'
          minecraft_version=1.21.1
          mod_id=examplemod
          mod_version=0.1.0
          loader_multi=false
          loader_type=forge
          java_version=21
          EOF

      - name: Run validate-dependencies action (missing file)
        id: deps_missing
        uses: XxInvictus/mc_universal_workflow/.github/actions/validate-dependencies@main
        with:
          project-root: fixture-no-deps

      - name: Assert validate-dependencies outputs (missing file)
        shell: bash
        run: |
          set -euo pipefail
          [[ "${{ steps.deps_missing.outputs.dependencies_present }}" == "false" ]]

      - name: Run prepare-test-env action
        id: prep
        uses: XxInvictus/mc_universal_workflow/.github/actions/prepare-test-env@main
        with:
          project-root: fixture

      - name: Assert prepare-test-env outputs
        shell: bash
        run: |
          set -euo pipefail
          [[ "${{ steps.prep.outputs.test_dir }}" == "run" ]]
          [[ "${{ steps.prep.outputs.mod_dir }}" == "run/mods" ]]
          [[ "${{ steps.prep.outputs.loader_type }}" == "forge" ]]
          [[ "${{ steps.prep.outputs.minecraft_version }}" == "1.21.1" ]]
          [[ -f "run/mods/examplemod-forge-1.21.1-0.1.0.jar" ]]
