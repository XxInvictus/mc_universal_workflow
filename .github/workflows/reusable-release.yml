name: 1. Reusable - Release (Artifacts)

on:
  workflow_call:
    inputs:
      project-root:
        description: Project root directory
        required: false
        type: string
        default: .
      gradle-args:
        description: Gradle arguments (tasks + flags)
        required: false
        type: string
        default: build
      runs-on:
        description: Runner label (ubuntu-latest or self-hosted label)
        required: false
        type: string
        default: ubuntu-latest
      publish-github:
        description: Publish assets to GitHub Releases
        required: false
        type: boolean
        default: false
      publish-modrinth:
        description: Publish to Modrinth (requires `modrinth-id` + `MODRINTH_TOKEN`)
        required: false
        type: boolean
        default: false
      modrinth-id:
        description: Modrinth project ID (e.g. `abcdEFGH`)
        required: false
        type: string
        default: ''
      modrinth-featured:
        description: Whether the Modrinth release should be featured
        required: false
        type: boolean
        default: false
      publish-curseforge:
        description: Publish to CurseForge (requires `curseforge-id` + `CURSEFORGE_TOKEN`)
        required: false
        type: boolean
        default: false
      curseforge-id:
        description: CurseForge project ID (numeric)
        required: false
        type: string
        default: ''
      version-type:
        description: Release type (release, beta, alpha)
        required: false
        type: string
        default: release
      changelog-mode:
        description: Changelog handling ('required' to validate and require RELEASE_CHANGELOG.md, 'custom' to skip validation but require a changelog file, 'generated' to skip validation and generate a simple changelog if missing)
        required: false
        type: string
        default: required
      changelog-path:
        description: Path (relative to project-root) to the changelog file used for the published release body. Default is RELEASE_CHANGELOG.md.
        required: false
        type: string
        default: RELEASE_CHANGELOG.md
      custom-changelog-behavior:
        description: When changelog-mode=custom, controls what gets published ('empty' publishes no changelog by default; 'full' publishes the entire file at changelog-path)
        required: false
        type: string
        default: empty
    secrets:
      MODRINTH_TOKEN:
        description: Modrinth API token
        required: false
      CURSEFORGE_TOKEN:
        description: CurseForge API token
        required: false

permissions:
  contents: read

jobs:
  build:
    name: Build and upload artifacts
    runs-on: ${{ inputs.runs-on }}
    outputs:
      artifact_paths: ${{ steps.artifacts.outputs.artifact_paths }}
      minecraft_version: ${{ steps.detect.outputs.minecraft_version }}
      mod_id: ${{ steps.detect.outputs.mod_id }}
      mod_version: ${{ steps.detect.outputs.mod_version }}
      loader_multi: ${{ steps.detect.outputs.loader_multi }}
      loader_type: ${{ steps.detect.outputs.loader_type }}
      active_loaders: ${{ steps.detect.outputs.active_loaders }}
      release_tag: ${{ steps.release_meta.outputs.release_tag }}
      loaders_multiline: ${{ steps.release_meta.outputs.loaders_multiline }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Checkout mc_universal_workflow scripts (sparse)
        uses: actions/checkout@v4
        with:
          repository: XxInvictus/mc_universal_workflow
          ref: main
          path: .mc_universal_workflow
          sparse-checkout: |
            scripts

      - name: Detect project configuration
        id: detect
        uses: XxInvictus/mc_universal_workflow/.github/actions/detect-project@main
        with:
          project-root: ${{ inputs.project-root }}

      - name: Compute release metadata
        id: release_meta
        shell: bash
        run: |
          set -euo pipefail
          minecraft_version="${{ steps.detect.outputs.minecraft_version }}"
          mod_version="${{ steps.detect.outputs.mod_version }}"
          loader_multi="${{ steps.detect.outputs.loader_multi }}"
          loader_type="${{ steps.detect.outputs.loader_type }}"
          active_loaders="${{ steps.detect.outputs.active_loaders }}"

          release_tag="${minecraft_version}-${mod_version}"

          loaders_multiline=""
          if [[ "$loader_multi" == "true" ]]; then
            IFS=',' read -r -a loaders <<< "$active_loaders"
            for loader in "${loaders[@]}"; do
              loaders_multiline+="${loader}"$'\n'
            done
          else
            loaders_multiline+="${loader_type}"$'\n'
          fi

          {
            echo "release_tag=${release_tag}"
            echo 'loaders_multiline<<EOF'
            printf '%s' "$loaders_multiline"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ steps.detect.outputs.java_version }}

      - name: Setup Gradle (cache)
        uses: gradle/actions/setup-gradle@v4

      - name: Install validation tools
        uses: XxInvictus/mc_universal_workflow/.github/actions/validate-dependencies@main
        with:
          project-root: ${{ inputs.project-root }}

      - name: Build (Gradle)
        shell: bash
        working-directory: ${{ inputs.project-root }}
        run: |
          set -euo pipefail
          if [[ ! -f "./gradlew" ]]; then
            echo "ERROR: gradlew not found at project root" >&2
            exit 1
          fi
          chmod +x ./gradlew
          ./gradlew ${{ inputs.gradle-args }}

      - name: Validate artifacts (single-loader)
        if: steps.detect.outputs.loader_multi != 'true'
        uses: XxInvictus/mc_universal_workflow/.github/actions/validate-artifacts@main
        with:
          project-root: ${{ inputs.project-root }}

      - name: Validate mappings (single-loader)
        if: steps.detect.outputs.loader_multi != 'true'
        uses: XxInvictus/mc_universal_workflow/.github/actions/validate-mappings@main
        with:
          project-root: ${{ inputs.project-root }}

      - name: Ensure strings (binutils) is available
        if: steps.detect.outputs.loader_multi == 'true'
        shell: bash
        run: |
          set -euo pipefail
          if command -v strings >/dev/null 2>&1; then
            exit 0
          fi
          echo "strings not found; attempting to install binutils" >&2
          if ! command -v apt-get >/dev/null 2>&1; then
            echo "ERROR: strings not found and apt-get is unavailable. Install binutils (strings) on the runner." >&2
            exit 1
          fi
          SUDO=""
          if command -v sudo >/dev/null 2>&1; then
            SUDO="sudo"
          fi
          $SUDO apt-get update -y
          $SUDO apt-get install -y binutils
          command -v strings >/dev/null 2>&1 || { echo "ERROR: strings still not available after attempting binutils install" >&2; exit 1; }

      - name: Validate artifacts and mappings (multi-loader)
        if: steps.detect.outputs.loader_multi == 'true'
        shell: bash
        run: |
          set -euo pipefail
          project_root="${{ inputs.project-root }}"
          active_loaders="${{ steps.detect.outputs.active_loaders }}"
          IFS=',' read -r -a loaders <<< "$active_loaders"
          for loader in "${loaders[@]}"; do
            echo "Validating loader=$loader"
            bash ./.mc_universal_workflow/scripts/validate-artifacts.sh --project-root "$project_root" --loader "$loader"
            bash ./.mc_universal_workflow/scripts/validate-mappings.sh --project-root "$project_root" --loader "$loader"
          done

      - name: Resolve enforced artifact paths
        id: artifacts
        shell: bash
        run: |
          set -euo pipefail

          project_root="${{ inputs.project-root }}"
          loader_multi="${{ steps.detect.outputs.loader_multi }}"
          active_loaders="${{ steps.detect.outputs.active_loaders }}"

          artifact_paths=""
          artifact_paths_workspace=""

          if [[ "$loader_multi" == "true" ]]; then
            IFS=',' read -r -a loaders <<< "$active_loaders"
            for loader in "${loaders[@]}"; do
              out_path="$(bash ./.mc_universal_workflow/scripts/compute-artifact-path.sh --project-root "$project_root" --loader "$loader" | sed -n 's/^artifact_path=//p' | head -n 1)"
              if [[ -z "$out_path" ]]; then
                echo "ERROR: failed to resolve artifact_path for loader=${loader}" >&2
                exit 1
              fi
              if [[ ! -f "${project_root%/}/${out_path}" ]]; then
                echo "ERROR: expected artifact missing: ${out_path}" >&2
                exit 1
              fi
              artifact_paths+="${out_path}"$'\n'
              artifact_paths_workspace+="${project_root%/}/${out_path}"$'\n'
            done
          else
            out_path="$(bash ./.mc_universal_workflow/scripts/compute-artifact-path.sh --project-root "$project_root" | sed -n 's/^artifact_path=//p' | head -n 1)"
            if [[ -z "$out_path" ]]; then
              echo "ERROR: failed to resolve artifact_path" >&2
              exit 1
            fi
            if [[ ! -f "${project_root%/}/${out_path}" ]]; then
              echo "ERROR: expected artifact missing: ${out_path}" >&2
              exit 1
            fi
            artifact_paths+="${out_path}"$'\n'
            artifact_paths_workspace+="${project_root%/}/${out_path}"$'\n'
          fi

          {
            echo 'artifact_paths<<EOF'
            printf '%s' "$artifact_paths"
            echo 'EOF'
            echo 'artifact_paths_workspace<<EOF'
            printf '%s' "$artifact_paths_workspace"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Create artifact root marker
        shell: bash
        run: |
          set -euo pipefail
          marker_path="${{ inputs.project-root }}/.mc_universal_workflow_artifact_root"
          mkdir -p "$(dirname "$marker_path")"
          printf 'artifact-root\n' > "$marker_path"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.release_meta.outputs.release_tag }}
          path: |
            ${{ inputs.project-root }}/.mc_universal_workflow_artifact_root
            ${{ steps.artifacts.outputs.artifact_paths_workspace }}
          if-no-files-found: error

  publish:
    name: Tag and publish
    if: ${{ inputs.publish-github || inputs.publish-modrinth || inputs.publish-curseforge }}
    needs: build
    runs-on: ${{ inputs.runs-on }}
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Checkout mc_universal_workflow scripts (sparse)
        uses: actions/checkout@v4
        with:
          repository: XxInvictus/mc_universal_workflow
          ref: main
          path: .mc_universal_workflow
          sparse-checkout: |
            scripts

      - name: Validate publishing inputs
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${{ inputs.publish-modrinth }}" == "true" ]]; then
            if [[ -z "${{ inputs.modrinth-id }}" ]]; then
              echo "ERROR: publish-modrinth=true but modrinth-id is empty" >&2
              exit 1
            fi
            if [[ -z "${{ secrets.MODRINTH_TOKEN }}" ]]; then
              echo "ERROR: publish-modrinth=true but MODRINTH_TOKEN is not set" >&2
              exit 1
            fi
          fi

          if [[ "${{ inputs.publish-curseforge }}" == "true" ]]; then
            if [[ -z "${{ inputs.curseforge-id }}" ]]; then
              echo "ERROR: publish-curseforge=true but curseforge-id is empty" >&2
              exit 1
            fi
            if [[ -z "${{ secrets.CURSEFORGE_TOKEN }}" ]]; then
              echo "ERROR: publish-curseforge=true but CURSEFORGE_TOKEN is not set" >&2
              exit 1
            fi
          fi

      - name: Validate changelog files (optional)
        if: ${{ inputs.changelog-mode == 'required' }}
        shell: bash
        run: |
          set -euo pipefail
          project_root="${{ inputs.project-root }}"
          bash ./.mc_universal_workflow/scripts/validate-changelogs.sh --project-root "${project_root}"

      - name: Download built artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.release_tag }}
          path: dist

      - name: Find previous release tag (same Minecraft version)
        id: prev_release
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          bash ./.mc_universal_workflow/scripts/find-previous-release-tag.sh \
            --repo "${{ github.repository }}" \
            --minecraft-version "${{ needs.build.outputs.minecraft_version }}" \
            --current-mod-version "${{ needs.build.outputs.mod_version }}" \
            >> "$GITHUB_OUTPUT"

      - name: Prepare changelog file
        id: changelog
        shell: bash
        run: |
          set -euo pipefail

          project_root="${{ inputs.project-root }}"
          release_tag="${{ needs.build.outputs.release_tag }}"
          out_file="${RUNNER_TEMP}/mc_universal_release_changelog.md"

          changelog_mode="${{ inputs.changelog-mode }}"
          changelog_relpath="${{ inputs.changelog-path }}"
          changelog_src="${project_root%/}/${changelog_relpath}"
          custom_behavior="${{ inputs.custom-changelog-behavior }}"

          case "$changelog_mode" in
            required)
              # Validation step already ran; here we still enforce the standard filename unless overridden.
              if [[ "$changelog_relpath" != "RELEASE_CHANGELOG.md" ]]; then
                echo "ERROR: changelog-path must be RELEASE_CHANGELOG.md when changelog-mode=required" >&2
                exit 1
              fi
              if [[ ! -f "$changelog_src" ]]; then
                echo "ERROR: RELEASE_CHANGELOG.md is required for releases (see templates/RELEASE_CHANGELOG.md)" >&2
                exit 1
              fi
              prev_mod_version="${{ steps.prev_release.outputs.previous_mod_version }}"
              if [[ -n "$prev_mod_version" ]]; then
                bash ./.mc_universal_workflow/scripts/extract-release-notes.sh \
                  --changelog-file "$changelog_src" \
                  --current-version "${{ needs.build.outputs.mod_version }}" \
                  --previous-version "$prev_mod_version" \
                  > "$out_file"
              else
                bash ./.mc_universal_workflow/scripts/extract-release-notes.sh \
                  --changelog-file "$changelog_src" \
                  --current-version "${{ needs.build.outputs.mod_version }}" \
                  > "$out_file"
              fi
              ;;
            custom)
              # Skip validation. By default, publish an empty changelog unless explicitly told to publish the full file.
              case "$custom_behavior" in
                empty)
                  : > "$out_file"
                  ;;
                full)
                  if [[ -z "$changelog_relpath" ]]; then
                    echo "ERROR: changelog-path is required when changelog-mode=custom and custom-changelog-behavior=full" >&2
                    exit 1
                  fi
                  if [[ ! -f "$changelog_src" ]]; then
                    echo "ERROR: changelog file not found at '${changelog_relpath}' (relative to project-root)" >&2
                    exit 1
                  fi
                  cp "$changelog_src" "$out_file"
                  ;;
                *)
                  echo "ERROR: invalid custom-changelog-behavior '${custom_behavior}' (expected: empty|full)" >&2
                  exit 1
                  ;;
              esac
              ;;
            generated)
              # Prefer a user-provided file if it exists; otherwise generate a minimal template.
              if [[ -n "$changelog_relpath" && -f "$changelog_src" ]]; then
                cp "$changelog_src" "$out_file"
              else
                minecraft_version="${{ needs.build.outputs.minecraft_version }}"
                mod_id="${{ needs.build.outputs.mod_id }}"
                loaders="${{ needs.build.outputs.loaders_multiline }}"
                created_date="$(date -u +%F)"

                {
                  echo "# ${mod_id} ${release_tag}"
                  echo
                  echo "Generated changelog (no changelog file provided)."
                  echo
                  echo "## Release"
                  echo "- Version: ${release_tag}"
                  echo "- Minecraft: ${minecraft_version}"
                  echo "- Date: ${created_date}"
                  echo
                  echo "## Loaders"
                  printf '%s\n' "${loaders}" | sed '/^$/d' | sed 's/^/- /'
                } > "$out_file"
              fi
              ;;
            *)
              echo "ERROR: invalid changelog-mode '${changelog_mode}' (expected: required|custom|generated)" >&2
              exit 1
              ;;
          esac

          echo "file=${out_file}" >> "$GITHUB_OUTPUT"

      - name: Ensure tag exists (idempotent)
        if: ${{ inputs.publish-github || inputs.publish-modrinth || inputs.publish-curseforge }}
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          bash ./.mc_universal_workflow/scripts/ensure-tag-exists.sh \
            --repo "${{ github.repository }}" \
            --tag "${{ needs.build.outputs.release_tag }}" \
            --sha "${{ github.sha }}" \
            --mode move

      - name: Publish (GitHub Releases only)
        if: ${{ inputs.publish-github && !inputs.publish-modrinth && !inputs.publish-curseforge }}
        uses: Kir-Antipov/mc-publish@v3.3
        env:
          # Defensive: prevent mc-publish from picking up provider tokens via env.
          MODRINTH_TOKEN: ''
          CURSEFORGE_TOKEN: ''
        with:
          github-token: ${{ github.token }}
          github-tag: ${{ needs.build.outputs.release_tag }}
          github-commitish: ${{ github.sha }}

          files: |
            dist/${{ needs.build.outputs.artifact_paths }}

          name: ${{ needs.build.outputs.mod_id }} ${{ needs.build.outputs.release_tag }}
          version: ${{ needs.build.outputs.release_tag }}
          version-type: ${{ inputs.version-type }}
          changelog-file: ${{ steps.changelog.outputs.file }}

          loaders: |
            ${{ needs.build.outputs.loaders_multiline }}
          game-versions: |
            ${{ needs.build.outputs.minecraft_version }}

      - name: Publish (GitHub Releases + Modrinth)
        if: ${{ inputs.publish-github && inputs.publish-modrinth && !inputs.publish-curseforge }}
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          github-token: ${{ github.token }}
          github-tag: ${{ needs.build.outputs.release_tag }}
          github-commitish: ${{ github.sha }}

          files: |
            dist/${{ needs.build.outputs.artifact_paths }}

          name: ${{ needs.build.outputs.mod_id }} ${{ needs.build.outputs.release_tag }}
          version: ${{ needs.build.outputs.release_tag }}
          version-type: ${{ inputs.version-type }}
          changelog-file: ${{ steps.changelog.outputs.file }}

          loaders: |
            ${{ needs.build.outputs.loaders_multiline }}
          game-versions: |
            ${{ needs.build.outputs.minecraft_version }}

          modrinth-id: ${{ inputs.modrinth-id }}
          modrinth-token: ${{ secrets.MODRINTH_TOKEN }}
          modrinth-featured: ${{ inputs['modrinth-featured'] }}

      - name: Publish (GitHub Releases + CurseForge)
        if: ${{ inputs.publish-github && !inputs.publish-modrinth && inputs.publish-curseforge }}
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          github-token: ${{ github.token }}
          github-tag: ${{ needs.build.outputs.release_tag }}
          github-commitish: ${{ github.sha }}

          files: |
            dist/${{ needs.build.outputs.artifact_paths }}

          name: ${{ needs.build.outputs.mod_id }} ${{ needs.build.outputs.release_tag }}
          version: ${{ needs.build.outputs.release_tag }}
          version-type: ${{ inputs.version-type }}
          changelog-file: ${{ steps.changelog.outputs.file }}

          loaders: |
            ${{ needs.build.outputs.loaders_multiline }}
          game-versions: |
            ${{ needs.build.outputs.minecraft_version }}

          curseforge-id: ${{ inputs.curseforge-id }}
          curseforge-token: ${{ secrets.CURSEFORGE_TOKEN }}

      - name: Publish (GitHub Releases + Modrinth + CurseForge)
        if: ${{ inputs.publish-github && inputs.publish-modrinth && inputs.publish-curseforge }}
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          github-token: ${{ github.token }}
          github-tag: ${{ needs.build.outputs.release_tag }}
          github-commitish: ${{ github.sha }}

          files: |
            dist/${{ needs.build.outputs.artifact_paths }}

          name: ${{ needs.build.outputs.mod_id }} ${{ needs.build.outputs.release_tag }}
          version: ${{ needs.build.outputs.release_tag }}
          version-type: ${{ inputs.version-type }}
          changelog-file: ${{ steps.changelog.outputs.file }}

          loaders: |
            ${{ needs.build.outputs.loaders_multiline }}
          game-versions: |
            ${{ needs.build.outputs.minecraft_version }}

          modrinth-id: ${{ inputs.modrinth-id }}
          modrinth-token: ${{ secrets.MODRINTH_TOKEN }}
          modrinth-featured: ${{ inputs['modrinth-featured'] }}

          curseforge-id: ${{ inputs.curseforge-id }}
          curseforge-token: ${{ secrets.CURSEFORGE_TOKEN }}

      - name: Publish (Modrinth only)
        if: ${{ !inputs.publish-github && inputs.publish-modrinth && !inputs.publish-curseforge }}
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          files: |
            dist/${{ needs.build.outputs.artifact_paths }}

          name: ${{ needs.build.outputs.mod_id }} ${{ needs.build.outputs.release_tag }}
          version: ${{ needs.build.outputs.release_tag }}
          version-type: ${{ inputs.version-type }}
          changelog-file: ${{ steps.changelog.outputs.file }}

          loaders: |
            ${{ needs.build.outputs.loaders_multiline }}
          game-versions: |
            ${{ needs.build.outputs.minecraft_version }}

          modrinth-id: ${{ inputs.modrinth-id }}
          modrinth-token: ${{ secrets.MODRINTH_TOKEN }}
          modrinth-featured: ${{ inputs['modrinth-featured'] }}

      - name: Publish (CurseForge only)
        if: ${{ !inputs.publish-github && !inputs.publish-modrinth && inputs.publish-curseforge }}
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          files: |
            dist/${{ needs.build.outputs.artifact_paths }}

          name: ${{ needs.build.outputs.mod_id }} ${{ needs.build.outputs.release_tag }}
          version: ${{ needs.build.outputs.release_tag }}
          version-type: ${{ inputs.version-type }}
          changelog-file: ${{ steps.changelog.outputs.file }}

          loaders: |
            ${{ needs.build.outputs.loaders_multiline }}
          game-versions: |
            ${{ needs.build.outputs.minecraft_version }}

          curseforge-id: ${{ inputs.curseforge-id }}
          curseforge-token: ${{ secrets.CURSEFORGE_TOKEN }}

      - name: Publish (Modrinth + CurseForge only)
        if: ${{ !inputs.publish-github && inputs.publish-modrinth && inputs.publish-curseforge }}
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          files: |
            dist/${{ needs.build.outputs.artifact_paths }}

          name: ${{ needs.build.outputs.mod_id }} ${{ needs.build.outputs.release_tag }}
          version: ${{ needs.build.outputs.release_tag }}
          version-type: ${{ inputs.version-type }}
          changelog-file: ${{ steps.changelog.outputs.file }}

          loaders: |
            ${{ needs.build.outputs.loaders_multiline }}
          game-versions: |
            ${{ needs.build.outputs.minecraft_version }}

          modrinth-id: ${{ inputs.modrinth-id }}
          modrinth-token: ${{ secrets.MODRINTH_TOKEN }}
          modrinth-featured: ${{ inputs['modrinth-featured'] }}

          curseforge-id: ${{ inputs.curseforge-id }}
          curseforge-token: ${{ secrets.CURSEFORGE_TOKEN }}
